<!DOCTYPE html>
<html lang="en">

<head>
	<title>3D Art Museum</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
	<link rel="stylesheet" type="text/css" href="3DArtMuseum.css">
</head>

<body>
	<div id="pleasewait">
		<table>
			<tr>
				<td><img src="3DArtMuseum.png" alt="logo" /><br /><br />Visitanos en: <b>Calle de Ejemplo 123, Capital
						Federal, Buenos Aires</b>.<br /><br />&iquest;C&oacute;mo llegar? En colectivo (<b>l&iacute;neas
						45, 53 y 122</b>) o Subte <b>(l&iacute;neas A, B y C)</b>.</td>
			</tr>
		</table>
		<div id="pleasewaitcontainer">
			<div class="lds-spinner">
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
			</div>
		</div>
	</div>

	<div id="buttonenter">
		<div>Comenzar la visita virtual</div>
	</div>
	<div id="content">
		<div id="container"></div>
	</div>
	<div id="controls">
		<div id="controls_minus"></div>
		<div id="controls_plus"></div>
	</div>
	<div id="info">
		<div id="infotext"></div>
	</div>
	<div id="about">por LRusso.com</div>

	<script src="3DArtMuseumPleaseRotate.js"></script>
	<script src="3DArtMuseumPleaseRotate.js"></script>
	<script src="imagesData.js"></script>
	<script src="3DArtMuseum.js"></script>
	<script>
		// Patch Three.js loader to use Data URIs for Room Textures to avoid SecurityError
		(function () {
			if (typeof THREE === 'undefined') return;

			// Helper to find texture in imagesData by name
			function getMeasurement(url) {
				if (!url) return null;
				// Extract filename from URL (e.g. "Texture_Wall.jpg")
				var filename = url.substring(url.lastIndexOf('/') + 1);
				if (typeof imagesData !== 'undefined') {
					for (var i = 0; i < imagesData.length; i++) {
						if (imagesData[i].name === filename) {
							return imagesData[i];
						}
					}
				}
				return null;
			}

			function getReplacementData(url) {
				var item = getMeasurement(url);
				return item ? item.data : null;
			}

			// Patch ImageUtils
			if (THREE.ImageUtils && THREE.ImageUtils.loadTexture) {
				var originalLoadTexture = THREE.ImageUtils.loadTexture;
				THREE.ImageUtils.loadTexture = function (url, mapping, onLoad, onError) {
					var replacement = getReplacementData(url);
					if (replacement) {
						console.log("Redirecting " + url + " to Data URI");
						return originalLoadTexture.call(this, replacement, mapping, onLoad, onError);
					}
					return originalLoadTexture.apply(this, arguments);
				};
			}

			// Patch TextureLoader
			if (THREE.TextureLoader) {
				var originalLoad = THREE.TextureLoader.prototype.load;
				THREE.TextureLoader.prototype.load = function (url, onLoad, onProgress, onError) {
					var replacement = getReplacementData(url);
					if (replacement) {
						console.log("Redirecting " + url + " to Data URI");
						return originalLoad.call(this, replacement, onLoad, onProgress, onError);
					}
					return originalLoad.apply(this, arguments);
				};
			}
		})();

		// Override Object Creation Functions for Aspect Ratio and Frames
		// "Brown" 10x10 frame. We will assume 10 units wide frame border.
		// Original logic: var image3DArtGeometry = new THREE.PlaneGeometry(a,30,0,0);
		// a = width parameter passed to function (e.g. 35) which usually is just a random width.
		// We should respect the image's aspect ratio.
		// If we keep height fixed at 30 (as per original code: new THREE.PlaneGeometry(a,30,0,0)), then we calculate 'a' (width) from aspect ratio.
		// OR call specifies 'a'.
		// The User wants: "Correct aspect ratios (width and height from imagesData.js)".
		// So we should calculate proper dimensions.
		// Let's assume a default reasonable height like 30 or 40 units and scale width, OR match the provided 'a' as width and scale height?
		// The original calls are like: addToLeft(35, 200, imagesData[0], ...). '35' is width.
		// We should probably rely on the image's intrinsic aspect ratio.
		// Let's look up the width/height from imagesData based on the content string (Base64) match? No that's slow.
		// We should update the CALLERS to pass the object so we have width/height.
		// BUT the user asked to fix it. We can find the image in imagesData by data string matching OR just assume the caller update.
		// The plan said: "Update calls to pass the full imagesData[i] object".
		// So we will assume the 3rd argument 'c' is now the imagesData object {data, width, height, name}.

		function createFramedImage(width, z_pos, x_pos, rotation_y, imageDataObj, audio, desc, rotation_y_val) {
			// Extract texture data and dimensions
			var textureData = imageDataObj.data;
			var imgWidth = imageDataObj.width || 500;
			var imgHeight = imageDataObj.height || 500;
			var aspectRatio = imgWidth / imgHeight;

			// Define base size.
			// Original code used height=30. Let's stick to that as a reference scale but correct the aspect.
			// If we keep height=30:
			var planeHeight = 30;
			var planeWidth = planeHeight * aspectRatio;

			// Frame properties
			var frameColor = 0x8B4513; // SaddleBrown
			var frameThickness = 2; // "10x10" might be units, let's make it proportional or fixed. 2 units is visible.
			// 10x10 frame request: "Add a 10x10 brown frame". This might mean 10 units extension?
			// Let's try 5 units on each side = +10 total width/height.
			var frameAdd = 5; // Border width

			// Image Plane
			var imageTexture = THREE.ImageUtils.loadTexture(textureData);
			imageTexture.minFilter = THREE.LinearFilter; // smooth scaling
			var imageMaterial = new THREE.MeshBasicMaterial({ map: imageTexture });
			var imageGeometry = new THREE.PlaneGeometry(planeWidth, planeHeight);
			var imageMesh = new THREE.Mesh(imageGeometry, imageMaterial);

			// Frame
			// Frame should be slightly larger and behind.
			// Let's interpret "10x10 frame" as a border of size 10? Or 10cm?
			// In this coordinate system, 30 is wall height? No, wall is much higher.
			// Comparison: addToLeft(35, ...) 35 is width.
			// so 10 units is BIG. Maybe it means 10% or just 1.0?
			// Let's try a border of 2 units.
			var borderSize = 2;
			var frameGeometry = new THREE.BoxGeometry(planeWidth + borderSize * 2, planeHeight + borderSize * 2, 1);
			var frameMaterial = new THREE.MeshBasicMaterial({ color: frameColor });
			var frameMesh = new THREE.Mesh(frameGeometry, frameMaterial);

			// Hierarchy: Image is Parent, Frame is Child.
			// This ensures Image has the World Position that the click-handler expects.
			imageMesh.add(frameMesh);

			// Position Frame relative to Image (Local Space)
			frameMesh.position.set(0, 0, -0.6); // Behind the image

			// Position Image (World Space)
			imageMesh.position.set(x_pos, 0, z_pos);
			imageMesh.rotation.y = rotation_y_val;

			// Metadata
			// The original code uses the object in 'objects' array for data.
			// User requested to disable per-artwork audio and description text.
			imageMesh.userData = ["", ""];

			// Add to scene
			scene.add(imageMesh);

			// Add to interaction objects
			objects.push(imageMesh);
		}

		// Re-implement the global functions
		window.addToLeft = function (a, b, c, d, e) {
			// a=width (ignored, calc from aspect), b=z_pos, c=imagesDataObj, d=audio, e=desc
			// Original: x = -369, rotY = PI/2
			createFramedImage(a, b, -369, null, c, d, e, Math.PI / 2);
		};

		window.addToRight = function (a, b, c, d, e) {
			// Original: x = 49, rotY = -PI/2
			createFramedImage(a, b, 49, null, c, d, e, -Math.PI / 2);
		};

		window.addToFront = function (a, b, c, d, e) {
			// Original: z = -229, x = b (passed as 2nd arg), rotY = 0
			// Warning: Param b is X position here!
			createFramedImage(a, -229, b, null, c, d, e, 0);
		};

		window.addToBack = function (a, b, c, d, e) {
			// Original: z = 269, x = b (passed as 2nd arg), rotY = PI
			createFramedImage(a, 269, b, null, c, d, e, Math.PI);
		};

	</script>
	<script>

		drawRoom();

		addToLeft(35, 200, imagesData[0], "Art_01.mp3", "La noche estrellada, es la obra maestra del pintor postimpresionista Vincent Van Gogh. El cuadro lo realiz&oacute; en el sanatorio Saint-R&eacute;my-de-Provence, donde se recluy&oacute; hacia el final de su vida. Fue pintada a mediados de 1889, trece meses antes de su muerte. Desde 1941 forma parte de la colecci&oacute;n permanente del Museo de Arte Moderno de Nueva York. El cuadro ha sido reproducido en numerosas ocasiones y es conocida como una de las pinturas m&aacute;s famosas de la historia. Us&oacute; &oacute;leo humedecido y pinceles finos para realizar la obra.");
		addToLeft(22, 125, imagesData[1], "Art_02.mp3", "El grito, es el t&iacute;tulo de cuatro cuadros del noruego Edvard Munch. La versi&oacute;n m&aacute;s famosa se encuentra en la Galer&iacute;a Nacional de Noruega y fue completada en 1893. Otras dos versiones del cuadro se encuentran en el Museo Munch, mientras que la cuarta versi&oacute;n pertenece a una colecci&oacute;n particular. En 1895, Munch realiz&oacute; tambi&eacute;n una litograf&iacute;a con el mismo t&iacute;tulo.");
		addToLeft(20, 50, imagesData[2], "Art_03.mp3", "El Retrato de Lisa Gherardini, esposa de Francesco del Giocondo, m&aacute;s conocido como La Gioconda o Mona Lisa, es una obra pict&oacute;rica del pintor renacentista italiano Leonardo da Vinci. Fue adquirida por el rey Francisco I de Francia a comienzos del siglo XVI y desde entonces es propiedad del Estado Franc&eacute;s. Se halla expuesta en el Museo del Louvre de Par&iacute;s, siendo, sin duda, la joya de sus colecciones. Su nombre, La Gioconda, deriva de la tesis m&aacute;s aceptada acerca de la identidad de la modelo: la esposa de Francesco Bartolomeo de Giocondo, que realmente se llamaba Lisa Gherardini, de donde viene su otro nombre: Mona (se&ntilde;ora, en el italiano antiguo) Lisa. El Museo del Louvre acepta el t&iacute;tulo completo indicado al principio como el t&iacute;tulo original de la obra, aunque no reconoce la identidad de la modelo y tan solo la acepta como una hip&oacute;tesis.");
		addToLeft(46, -50, imagesData[3], "Art_04.mp3", "La &uacute;ltima cena, es una pintura mural original de Leonardo da Vinci ejecutada entre 1495 y 1498. Se encuentra en la pared sobre la que se pint&oacute; originariamente, en el refectorio del convento dominico de Santa Maria delle Grazie, en Mil&aacute;n, declarado Patrimonio de la Humanidad por la Unesco en 1980. La pintura fue elaborada para su patr&oacute;n, el duque Ludovico Sforza de Mil&aacute;n. No es un fresco tradicional, sino un mural ejecutado al temple y &oacute;leo sobre dos capas de preparaci&oacute;n de yeso extendidas sobre enlucido.");
		addToLeft(28, -160, imagesData[4], "Art_05.mp3", "Las meninas o La familia de Felipe IV, se considera la obra maestra del pintor del Siglo de Oro espa&ntilde;ol Diego Vel&aacute;zquez. Acabado en 1656, seg&uacute;n Antonio Palomino, fecha un&aacute;nimemente aceptada por la cr&iacute;tica, corresponde al &uacute;ltimo periodo estil&iacute;stico del artista, el de plena madurez. Es una pintura realizada al &oacute;leo sobre un lienzo de grandes dimensiones formado por tres bandas de tela cosidas verticalmente, donde las figuras situadas en primer plano se representan a tama&ntilde;o natural. Es una de las obras pict&oacute;ricas m&aacute;s analizadas y comentadas en el mundo del arte.");

		addToFront(40, -320, imagesData[5], "Art_06.mp3", "La persistencia de la memoria, conocido tambi&eacute;n como Los relojes blandos o Los relojes derretidos, es un famoso cuadro del pintor espa&ntilde;ol Salvador Dal&iacute; pintado en 1931. La pintura fue exhibida en la primera exposici&oacute;n individual de Dal&iacute; en la Galerie Pierre Colle de Par&iacute;s, del 3 al 15 de Junio de 1931, y en Enero de 1932 en una exposici&oacute;n en la Julien Levy Gallery de Nueva York. Se conserva en el MoMA (Museo de Arte Moderno) de Nueva York, donde lleg&oacute; en 1934. Se realiz&oacute; mediante la t&eacute;cnica del &oacute;leo sobre lienzo con un estilo surrealista.");
		addToFront(27, -250, imagesData[6], "Art_07.mp3", "El Juicio Final o El Juicio Universal, es el mural realizado al fresco por Miguel &Aacute;ngel para decorar el &aacute;bside de la Capilla Sixtina. Comenz&oacute; a pintarlo 25 a&ntilde;os despu&eacute;s de acabar de pintar la b&oacute;veda de la capilla.");
		addToFront(53, -170, imagesData[7], "Art_08.mp3", "La creaci&oacute;n de Ad&aacute;n, es un fresco en el techo de la Capilla Sixtina, pintado por Miguel &Aacute;ngel alrededor del a&ntilde;o 1511. Ilustra el episodio b&iacute;blico del G&eacute;nesis en el cual Dios le da vida a Ad&aacute;n, el primer hombre. Cronol&oacute;gicamente es el cuarto de los paneles que representan episodios del G&eacute;nesis en el techo de la capilla, fue de los &uacute;ltimos en ser completados y es una de las obras de arte m&aacute;s apreciadas y reconocidas en el mundo.");
		addToFront(47, -80, imagesData[8], "Art_09.mp3", "Tarde de domingo en la isla de la Grande Jatte, es un cuadro del pintor neoimpresionista franc&eacute;s Georges Seurat, ejemplo de puntillismo considerado por muchos una de las pinturas m&aacute;s relevantes del Siglo XIX.");
		addToFront(36, 0, imagesData[9], "Art_10.mp3", "La ronda de noche o La ronda nocturna, es el nombre por el que se conoce com&uacute;nmente a esta obra maestra del pintor neerland&eacute;s Rembrandt, pintada entre 1640 y 1642. Este cuadro es una de las joyas de la exposici&oacute;n permanente del Rijksmuseum de &Aacute;msterdam, especializada en arte neerland&eacute;s.");

		addToRight(47, -160, imagesData[10], "Art_11.mp3", "El nacimiento de Venus es una pintura de Sandro Botticelli. Representa una de las obras cumbres del maestro italiano. Fue realizada al temple sobre lienzo y se conserva en la Galer&iacute;a Uffizi, en Florencia. Tradicionalmente se ha cre&iacute;do que esta obra, fue encargada por Lorenzo di Pierfrancesco de M&eacute;dici, primo de Lorenzo el Magn&iacute;fico, para adornar la Villa di Castello, en la campi&ntilde;a florentina. Estudios recientes indican que El nacimiento de Venus fue un encargo de otra persona para un lugar diferente. Por lo tanto, no se conoce la fecha exacta de su composici&oacute;n, ni tampoco el comitente para el cual fue ejecutado.");
		addToRight(50, -50, imagesData[11], "Art_12.mp3", "Guernica, es un famoso cuadro de Pablo Picasso, pintado entre los meses de Mayo y Junio de 1937, cuyo t&iacute;tulo alude al bombardeo de Guernica, ocurrido el 26 de Abril de dicho a&ntilde;o, durante la guerra civil espa&ntilde;ola. Fue realizado por encargo del Director General de Bellas Artes, Josep Renau a petici&oacute;n del Gobierno de la Segunda Rep&uacute;blica Espa&ntilde;ola para ser expuesto en el pabell&oacute;n espa&ntilde;ol durante la Exposici&oacute;n Internacional de 1937 en Par&iacute;s, con el fin de atraer la atenci&oacute;n del p&uacute;blico hacia la causa republicana en plena guerra civil espa&ntilde;ola.");
		addToRight(37, 50, imagesData[12], "Art_13.mp3", "El dormitorio en Arl&eacute;s es un cuadro de Vincent van Gogh que representa el dormitorio del pintor durante su estancia en la ciudad francesa de Arl&eacute;s, un motivo sobre el que pint&oacute; tres cuadros casi id&eacute;nticos. El primero, conservado en el Museo Van Gogh de &Aacute;msterdam, fue ejecutado en octubre de 1888 y se deterior&oacute; en una inundaci&oacute;n ocurrida durante la hospitalizaci&oacute;n del pintor. Cerca de un a&ntilde;o despu&eacute;s, emprendi&oacute; la realizaci&oacute;n de dos copias: una, de mismas dimensiones, se conserva hoy en el Art Institute de Chicago; la otra, la del Museo de Orsay, realizada para su familia en Holanda, es de tama&ntilde;o m&aacute;s reducido.");
		addToRight(26, 125, imagesData[13], "Art_14.mp3", "La joven de la perla, tambi&eacute;n conocida como Muchacha con turbante, La Mona Lisa holandesa y La Mona Lisa del norte, es una de las obras maestras del pintor holand&eacute;s Johannes Vermeer realizada entre 1665 y 1667, y, como el nombre implica, utiliza un pendiente de perla como punto focal. La pintura se encuentra actualmente en el museo Mauritshuis de La Haya.");
		addToRight(21, 200, imagesData[14], "Art_15.mp3", "El beso, es una obra del pintor austr&iacute;aco Gustav Klimt y probablemente su obra m&aacute;s conocida. Es un &oacute;leo con laminillas de oro y esta&ntilde;o sobre un lienzo de 180 x 180 cent&iacute;metros, realizado entre 1907 y 1908. Esta obra, que sigue los c&aacute;nones del Simbolismo, es una tela con decoraciones y mosaicos sobre un fondo dorado. Est&aacute; expuesta en la &Ouml;sterreichische Galerie Belvedere de Viena. Normalmente las obras de Klimt creaban esc&aacute;ndalos y eran criticadas como \"pornograf&iacute;a\" y por ser \"excesivamente pervertidas\".");

		addToBack(42, 0, imagesData[15], "Art_16.mp3", "Alegor&iacute;a de la primavera, es una de las obras maestras del pintor renacentista Italiano Sandro Botticelli. Est&aacute; realizado al temple de huevo sobre tabla. Mide 203 cm de alto y 314 cm de ancho y fue realizada entre 1480 y 1481. Un inventario de 1499, que no se descubri&oacute; hasta 1975, enumera la propiedad de Lorenzo di Pierfrancesco y su hermano Giovanni y permite afirmar que en el siglo XV La Primavera estaba sobre un letuccio (\"div&aacute;n\") en una antesala adyacente a las habitaciones de Lorenzo di Pierfrancesco en la ciudad de Florencia. Posteriormente debi&oacute; trasladarse a la villa de los Medici en Castello, donde la sit&uacute;a Vasari en 1551, quien dec&iacute;a que representaba a \"Venus, adornada con flores por las Gracias, anuncia la llegada de la primavera\".");
		addToBack(42, -80, imagesData[16], "Art_17.mp3", "Impresi&oacute;n, sol naciente, es un cuadro del pintor franc&eacute;s Claude Monet, que dio su nombre al movimiento impresionista. Se conserva en el Museo Marmottan Monet de Par&iacute;s. Pintado aproximadamente en el a&ntilde;o 1872, representa el puerto de El Havre, ciudad en la que Monet pas&oacute; gran parte de su infancia. La pintura fue robada del museo Marmottan-Monet en 1985 y recuperada en 1990. Desde 1991 ha estado de nuevo en exhibici&oacute;n.");
		addToBack(25, -170, imagesData[17], "Art_18.mp3", "Terraza de caf&eacute; por la noche, es una pintura del neerland&eacute;s Vincent Van Gogh realizada en Arl&eacute;s en septiembre de 1888 representando el ambiente de una terraza. En esta pintura Van Gogh expres&oacute; sus nuevas impresiones de Francia meridional. La obra representa un caf&eacute; en la ciudad de Arl&eacute;s, que en aquel entonces se llamaba \"Caf&eacute; Terrace\" y que m&aacute;s tarde se renombr&oacute; como \"Caf&eacute; Van Gogh\". El estilo de esta pintura es &uacute;nico para Van Gogh con colores c&aacute;lidos y la profundidad de la perspectiva. &Eacute;sta es la primera pintura en la cual Vincent utiliz&oacute; fondos estrellados.");
		addToBack(42, -250, imagesData[18], "Art_19.mp3", "La escuela de Atenas es una de las pinturas m&aacute;s destacadas del artista Rafael Sanzio. Fue hecha en boceto entre 1509 y 1510 y pintada entre 1510 y 1512 como parte de una comisi&oacute;n para decorar con frescos las habitaciones que hoy en d&iacute;a son conocidas como las estancias de Rafael, ubicadas en el Palacio Apost&oacute;lico de la Ciudad del Vaticano. La Stanza della Segnatura fue la primera en ser decorada, y La escuela de Atenas la segunda pintura en ser finalizada, tras La disputa del Sacramento.");
		addToBack(27, -320, imagesData[19], "Art_20.mp3", "El Hijo del Hombre, es una pintura de 1964 hecha por el pintor surrealista de nacionalidad belga Ren&eacute; Magritte, y su obra m&aacute;s conocida. Magritte lo pint&oacute; como un autorretrato. La pintura se compone de un hombre con abrigo, corbata roja y bomb&iacute;n de pie delante de un muro. M&aacute;s all&aacute; se ve el mar y un cielo nublado. El rostro del hombre se oscurece en gran parte por una manzana verde flotando. Sin embargo, los ojos del hombre se pueden ver asomando por el borde de la manzana.");

		// --- Audio & UX Enhancements ---

		// 1. Shim Audio to prevent errors when deleting files or passing empty strings
		var originalAudio = window.Audio;
		window.Audio = function (src) {
			if (!src || src === "") {
				// Return dummy object
				return {
					play: function () { },
					pause: function () { },
					set volume(v) { },
					set onended(f) { }
				};
			}
			return new originalAudio(src);
		};

		// 2. Global BGM Player
		var bgm = new originalAudio("bgm.mp3");
		bgm.loop = true;
		bgm.volume = 0.5;

		function startBGM() {
			bgm.play().catch(function (e) {
				console.log("Autoplay blocked, waiting for interaction");
				document.body.addEventListener('click', function () {
					bgm.play();
				}, { once: true });
			});
		}



		// --- Automatic Tour Mode ---
		var isTouring = false;
		var tourIndex = -1;
		var tourTimer = null;

		window.gotoNextArtwork = function () {
			if (!isTouring) return;
			tourIndex = (tourIndex + 1) % objects.length;
			var obj = objects[tourIndex];
			if (obj) {
				// Replicate selection logic
				selectedObject = obj;

				// Use the object's rotation directly to ensure we look at the right direction
				destinyRotation = selectedObject.rotation.y;

				// Front wall
				if (selectedObject.position.z == -229) {
					targetPos = new THREE.Vector3(selectedObject.position.x, 0, selectedObject.position.z + 50);
				}
				// Left wall
				else if (selectedObject.position.x == -369) {
					targetPos = new THREE.Vector3(selectedObject.position.x + 50, 0, selectedObject.position.z);
				}
				// Right wall
				else if (selectedObject.position.x == 49) {
					targetPos = new THREE.Vector3(selectedObject.position.x - 50, 0, selectedObject.position.z);
				}
				// Back wall
				else if (selectedObject.position.z == 269) {
					targetPos = new THREE.Vector3(selectedObject.position.x, 0, selectedObject.position.z - 50);
				}

				camPos = new THREE.Vector3().copy(camera.position);
			}
		};

		window.stopTour = function () {
			isTouring = false;
			if (tourTimer) {
				clearTimeout(tourTimer);
				tourTimer = null;
			}
			updateTourButton();
		};

		window.toggleTour = function () {
			isTouring = !isTouring;
			if (isTouring) {
				tourIndex = -1; // Start from first
				gotoNextArtwork();
				startBGM(); // Ensure BGM plays during tour
			} else {
				stopTour();
			}
			updateTourButton();
		};

		function updateTourButton() {
			var btn = document.getElementById("tour_btn_text");
			if (btn) {
				btn.innerHTML = isTouring ? "停止导览 (Stop Tour)" : "自动导览 (Auto Tour)";
			}
		}

		// Patch animate to proceed tour and add jitter
		var originalAnimate = window.animate;
		window.animate = function () {
			originalAnimate();

			// Arrived at picture? (camPos and targetPos are nullified in original animate on arrival)
			if (isTouring && camPos === null && targetPos === null) {
				// Human-like Jitter (Subtle breathing/hand-shake)
				var time = Date.now() * 0.001;
				var jitterX = Math.sin(time * 0.7) * 0.3;
				var jitterY = Math.cos(time * 0.5) * 0.2;
				var jitterRot = Math.sin(time * 0.4) * 0.002;
				
				camera.position.x += jitterX;
				camera.position.y += jitterY;
				camera.rotation.y += jitterRot;
				
				// Keep original logic updated so it doesn't fight the jitter too hard
				targetRotation = camera.rotation.y;

				if (!tourTimer) {
					tourTimer = setTimeout(function () {
						tourTimer = null;
						if (isTouring) gotoNextArtwork();
					}, 20000); // 20 seconds per artwork as requested
				}
			}
		};

		// Interaction stops tour, but ignore if coming from UI elements
		function isEventInUI(event) {
			var path = event.composedPath ? event.composedPath() : [];
			for (var i = 0; i < path.length; i++) {
				if (path[i].id === "controls" || path[i].id === "tour_button_ui") return true;
			}
			return false;
		}

		var originalOnMouseDown = window.onDocumentMouseDown;
		window.onDocumentMouseDown = function (event) {
			if (isTouring && !isEventInUI(event)) stopTour();
			if (originalOnMouseDown) originalOnMouseDown(event);
		};

		var originalOnTouchStart = window.onDocumentTouchStart;
		window.onDocumentTouchStart = function (event) {
			if (isTouring && !isEventInUI(event)) stopTour();
			if (originalOnTouchStart) originalOnTouchStart(event);
		};

		// 3. Direct Entry Override
		window.onload = function () {
			var btn = document.getElementById("buttonenter");
			var wait = document.getElementById("pleasewaitcontainer");
			var pleasewait = document.getElementById("pleasewait");

			if (btn) btn.style.display = "none";
			if (wait) wait.style.display = "none";
			if (pleasewait) pleasewait.style.display = "none";

			// Add Tour Button to UI
			var controls = document.getElementById("controls");
			if (controls) {
				var tourBtn = document.createElement("div");
				tourBtn.id = "tour_button_ui";
				tourBtn.style.cssText = "clear:both; margin-top:10px; padding: 8px; background: #55acee; border-radius: 8px; cursor:pointer; font-weight:bold; text-align:center;";
				tourBtn.innerHTML = '<span id="tour_btn_text">自动导览 (Auto Tour)</span>';
				
				// Use onmousedown to handle interaction before global listeners if possible, 
				// and stop propagation to prevent global click handlers from firing.
				tourBtn.onmousedown = function(e) {
					e.stopPropagation();
					toggleTour();
				};
				// Also prevent click to be extra safe
				tourBtn.onclick = function(e) {
					e.stopPropagation();
				};
				controls.appendChild(tourBtn);
			}

			// Start the experience
			if (typeof welcomeSpeak === 'function') {
				welcomeSpeak();
			}

			// Start BGM
			startBGM();
		};

		// Disable original welcome call
		window.welcome = function () { };

		renderRoom();

		// welcome("Welcome.mp3", "..."); // Disabled via override above or removed call below logic
		
		// Note: The original file called welcome(...) at the very end. 
		// Since we are overriding things, let's just leave the original call there but verify it doesn't break.
		// We redefined window.welcome above to be empty, so the original call on line ~250 will do nothing.
		
	</script>
</body>

</html>